<DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" href="/style.css">
    <title>Document</title>
</head>
<body>
    <nav>
      {{!-- <h4>Node MySQL</h4> --}}
      <ul>
        <li><a href="/search">Search</a></li>
        <li><a href="/share">Share</a></li>
        <li><a href="/trips">Trips</a></li>
      </ul>
      <ul>
      <li><a href="/">Home</a></li>
      <li><a href="/logout">Logout</a></li>
      </ul>
    </nav>

    <div class="container-fluid" >
    <div class="row-fluid">
      <div id="search-bar">
        <!--Sidebar content-->
        <form class="form-horizontal well" id="search"  action="/auth/search" method="post">
        <fieldset>
          <div class="control-group" id="search-route">
            <!-- From -->
            <div class="control-group">
              <label class="control-label">From</label>
              <div class="controls">
                <input required class="input-xlarge" name = "src" id="search-from" type="text" placeholder="Type the name of a place or address over here">
              </div>
            </div>
            {{!-- <select id="start" name= "src">
              <option value="chicago, il">Chicago</option>
              <option value="st louis, mo">St Louis</option>
              <option value="joplin, mo">Joplin, MO</option>
              <option value="oklahoma city, ok">Oklahoma City</option>
              <option value="amarillo, tx">Amarillo</option>
              <option value="gallup, nm">Gallup, NM</option>
              <option value="flagstaff, az">Flagstaff, AZ</option>
              <option value="winona, az">Winona</option>
              <option value="kingman, az">Kingman</option>
              <option value="barstow, ca">Barstow</option>
              <option value="san bernardino, ca">San Bernardino</option>
              <option value="los angeles, ca">Los Angeles</option>
          </select> --}}

            <!-- To -->
            <div class="control-group">
              <label class="control-label">To</label>
              <div class="controls">
                <input required class="input-xlarge" name= "dst" id="search-to" type="text" placeholder="Type the name of a place or address over here">
              </div>
            </div>
          </div>

          <!-- Departure Date -->
          <div class="control-group" id="search-departure">
            <label class="control-label">Date</label>
            <div class="controls">
              <div class="input-append date" id="search-departure-date">
               {{!-- <input class="span8" size="16" type="text" >
                 <span class="add-on"><i class="fas fa-calendar-week"></i></span> --}}
                 <input type="date" value="19-11-2021" name='date'>
              </div>
            </div>
          </div>

          <!-- Departure Time -->
          <div class="control-group" id="search-departure">
            <label class="control-label">Time</label>
            <div class="controls">
              <div class="input-append time" id="search-departure-time">
               {{!-- <input class="span8" size="16" type="text" >
                 <span class="add-on"><i class="fas fa-calendar-week"></i></span> --}}
                 <input type="time" name='time' value="22:00">
              </div>
            </div>
          </div>
        
          <!-- Women Only -->
          {{!-- <div class="control-group" >
           <label class="checkbox">
            <div class="controls">
             <input type="checkbox" id="search-women-only" name="womenCheck"> Women Only
             </div>
           </label>
          </div> --}}

         <!-- Search Button -->
         <br>
         <div class="form-actions" >
           <button type="submit" id="search-button" class="btn btn-primary"><i class="fas fa-search"></i>Search</button>
         </div>
         </fieldset>
         </form>

         <div id="result" type='hidden'>
          <ul class="list-group">
            <li id="in_mile">Distance In Mile :</li>
            <li id="in_kilo">Distance is Kilo:</li>
            <li id='duration_text'>IN TEXT:</li>
            {{!-- <li>IN MINUTES:</li>
            <li>FROM:</li>
            <li>TO:</li> --}}
          </ul>
        </div>
        
        </><!-- End Sidebar Content -->
        <div class="well" id="search-results">
          <h4>Search Results</h4>
          <div>
            {{#if results}}
            <form action='trips' method="post">
            <table class = 'table table-stripped'>
            <thead>
              <tr>
                <th> id</th>
                <th> From </th>
                <th> To </th>
                <th> date</th>
                <th> time</th>
                {{!-- <th> Select Ride</th> --}}
                {{!-- <th> women</th> --}}
              </tr>
            </thead>
            {{#each results}}
            <tr>
              <td>{{this.id}}</td>
              <td> {{this.source}} </td>
               <td> {{this.destination}} </td>
               <td>{{this.date}}</td>
               <td> {{this.time}}</td>
               <td><button type="submit" class="btn" name="tripId" value="{{this.id}}">Request</input></td>
              <!-- no need to know which user clicked the button because it's in the session.userId --> 
              <!-- I can't use id attr with td tag --> 
            </tr>
            {{/each}}
              </table>
              </form>
            {{/if}}
            {{#if message}}
              <h4 class="alert alert-danger mt-4">{{message}}</h4>
            {{/if}}
          </div>
        </div>
      </div>
      <div id="map" class="well"></div>
    </div>
  </div>
  {{!-- <script>
        function initMap(){
          var options = {
            zoom:8, 
            center: { lat: 34.1156, lng: 35.6744 }
          }
        var map = new google.maps.Map(document.getElementById("map"), options);
         addMarker({lat:34.11574789323503, lng:35.674445433426555}, map);
         addMarker({lat:33.87533032253132, lng:35.495385946712474}, map);
  
        } 
        function addMarker(coords, map){
          var marker = new google.maps.Marker({
            position: coords, 
            map: map 
          })
        }
      </script> --}}
     
      {{!-- <script>
        $(function () {
          var origin, destination, map;

          // add input listeners
          google.maps.event.addDomListener(window, 'load', function (listener) {
              setDestination();
              initMap();
          });

          // init or load map
          function initMap() {

              var myLatLng = {
                  lat: 52.520008,
                  lng: 13.404954
              };
              map = new google.maps.Map(document.getElementById('map'), {zoom: 16, center: myLatLng,});
          }

          function setDestination() {
              var from_places = new google.maps.places.Autocomplete(document.getElementById('search-from'));
              var to_places = new google.maps.places.Autocomplete(document.getElementById('search-to'));

              google.maps.event.addListener(from_places, 'place_changed', function () {
                  var from_place = from_places.getPlace();
                  var from_address = from_place.formatted_address;
                  $('#origin').val(from_address);
              });

              google.maps.event.addListener(to_places, 'place_changed', function () {
                  var to_place = to_places.getPlace();
                  var to_address = to_place.formatted_address;
                  $('#destination').val(to_address);
              });
          }

          function displayRoute(travel_mode, origin, destination, directionsService, directionsDisplay) {
              directionsService.route({
                  origin: origin,
                  destination: destination,
                  travelMode: travel_mode,
                  avoidTolls: true
              }, function (response, status) {
                  if (status === 'OK') {
                      directionsDisplay.setMap(map);
                      directionsDisplay.setDirections(response);
                  } else {
                      directionsDisplay.setMap(null);
                      directionsDisplay.setDirections(null);
                      alert('Could not display directions due to: ' + status);
                  }
              });
          }
      </script> --}}

    <script>
        function initMap() {
          var directionsService = new google.maps.DirectionsService;
          var directionsDisplay = new google.maps.DirectionsRenderer;
          var map = new google.maps.Map(document.getElementById('map'), {
            zoom: 7,
            center: {lat: 34.1156, lng: 35.6744}
          });
          directionsDisplay.setMap(map);

          calculateAndDisplayRoute(directionsService, directionsDisplay);
          calculateDistance();
          /*var onChangeHandler = function() {
            calculateAndDisplayRoute(directionsService, directionsDisplay);
          };
          document.getElementById('search-from').addEventListener('change', onChangeHandler);
          document.getElementById('search-to').addEventListener('change', onChangeHandler);*/
        }

        function calculateAndDisplayRoute(directionsService, directionsDisplay) {
          directionsService.route({
            origin: 'Beirut, Lebanon',
            destination: 'Byblos, Lebanon',
            travelMode: 'DRIVING'
          }, function(response, status) {
            if (status === 'OK') {
              directionsDisplay.setDirections(response);
            } else {
              window.alert('Directions request failed due to ' + status);
            }
          }); 
        }
          function calculateDistance(){
            var DistanceMatrixService = new google.maps.DistanceMatrixService();
            DistanceMatrixService.getDistanceMatrix(
              {
                origins: ['Beirut, Lebanon'],
                destinations: ['Byblos, Lebanon'],
                travelMode: google.maps.TravelMode["DRIVING"],
                unitSystem: google.maps.UnitSystem.metric,
                avoidHighways: false,
                avoidTolls: false
              }, save_results);
          }
          function save_results(response, status) {

            if (status != google.maps.DistanceMatrixStatus.OK) {
                $('#result').html(err);
            } else {
                var origin = response.originAddresses[0];
                var destination = response.destinationAddresses[0];
                if (response.rows[0].elements[0].status === "ZERO_RESULTS") {
                    $('#result').html("Sorry , not available to use this travel mode between " + origin + " and " + destination);
                } else {
                    var distance = response.rows[0].elements[0].distance;
                    var duration = response.rows[0].elements[0].duration;
                    var distance_in_kilo = distance.value / 1000; // the kilo meter
                    var distance_in_mile = distance.value / 1609.34; // the mile
                    var duration_text = duration.text;
                    console.log(duration)
                    appendResults(distance_in_kilo, distance_in_mile, duration_text);
                }
            }
        }
        function appendResults(distance_in_kilo, distance_in_mile, duration_text) {
            //$("#result").removeClass("hide");
            $('#in_mile').html(" Distance in Mile: <span class='badge badge-pill badge-secondary'>" + distance_in_mile.toFixed(2) + "</span>");
            $('#in_kilo').html("Distance in KM: <span class='badge badge-pill badge-secondary'>" + distance_in_kilo.toFixed(2) + "</span>");
            $('#duration_text').html("Duration: <span class='badge badge-pill badge-success'>" + duration_text + "</span>");
        }
      </script>

      <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=API_key&callback=initMap"> 
      </script>
      
</body>


</html>