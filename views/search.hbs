<DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" href="/style.css">
    <title>Document</title>
</head>
<body>
    <nav>
      {{!-- <h4>Node MySQL</h4> --}}
      <ul>
        <li><a href="/search">Search</a></li>
        <li><a href="/share">Share</a></li>
        <li><a href="/trips">Trips</a></li>
      </ul>
      <ul>
      <li><a href="/">Home</a></li>
      <li><a href="/logout">Logout</a></li>
      </ul>
    </nav>

    <div class="container-fluid" >
    <div class="row-fluid">
      <div id="search-bar">
        <!--Sidebar content-->
        <form class="form-horizontal well" id="search"  action="/auth/search" method="post">
        <fieldset>
          <div class="control-group" id="search-route">
            <!-- From -->
            {{!-- <div class="control-group">
              <label class="control-label">From</label>
              <div class="controls">
                <input required class="input-xlarge" name = "src" id="search-from" type="text" placeholder="Type the name of a place or address over here">
              </div>
            </div> --}}
            <div>
              <label class="control-label">From</label>
              <div>
              <select id="from" name= "src">
                <option value="AUB Sea Gate, Beirut">AUB Sea Gate, Beirut</option>
                <option value="Downtown Beirut">Downtown Beirut</option>
                <option value="City Mall, Jdeideh">City Mall</option>
                <option value="LeMall Dbayeh">LeMall, Dbayeh</option>
                <option value="Kaslik، Jounieh">Kaslik, Jounieh</option>
                <option value="POULE D'OR, Jounieh">Poule Dor, Jounieh</option>
                <option value="Highway, Bouar">Bouar</option>
                <option value="Chamsine Bakery , Zelhmaya">Chamsine Bakery, Halet</option>
                <option value="Spinneys Jbeil">Spinneys Jbeil</option>
                <option value="LAU, Jbeil">LAU, Jbeil</option>
            </select>
            </select>
            </div>
          </div>
            <!-- To -->
            {{!-- <div class="control-group">
              <label class="control-label">To</label>
              <div class="controls">
                <input required class="input-xlarge" name= "dst" id="search-to" type="text" placeholder="Type the name of a place or address over here">
              </div>
            </div>
          </div> --}}

          <div>
              <label class="control-label">To</label>
              <div>
              <select id="to" name= "dst">
                <option value="AUB Sea Gate, Beirut">AUB Sea Gate, Beirut</option>
                <option value="Downtown Beirut">Downtown Beirut</option>
                <option value="City Mall, Jdeideh">City Mall</option>
                <option value="LeMall Dbayeh">LeMall, Dbayeh</option>
                <option value="Kaslik، Jounieh">Kaslik, Jounieh</option>
                <option value="POULE D'OR, Jounieh">Poule Dor, Jounieh</option>
                <option value="Highway, Bouar">Bouar</option>
                <option value="Chamsine Bakery , Zelhmaya">Chamsine Bakery, Halet</option>
                <option value="Spinneys Jbeil">Spinneys Jbeil</option>
                <option value="LAU, Jbeil">LAU, Jbeil</option>
            </select>
            </div>
          </div>

          <!-- Departure Date -->
          <div class="control-group" id="search-departure">
            <label class="control-label">Date</label>
            <div class="controls">
              <div class="input-append date" id="search-departure-date">
               {{!-- <input class="span8" size="16" type="text" >
                 <span class="add-on"><i class="fas fa-calendar-week"></i></span> --}}
                 <input type="date" value="19-11-2021" name='date'>
              </div>
            </div>
          </div>

          <!-- Departure Time -->
          <div class="control-group" id="search-departure">
            <label class="control-label">Time</label>
            <div class="controls">
              <div class="input-append time" id="search-departure-time">
               {{!-- <input class="span8" size="16" type="text" >
                 <span class="add-on"><i class="fas fa-calendar-week"></i></span> --}}
                 <input type="time" name='time'>
              </div>
            </div>
          </div>
        
          <!-- Women Only -->
          {{!-- <div class="control-group" >
           <label class="checkbox">
            <div class="controls">
             <input type="checkbox" id="search-women-only" name="womenCheck"> Women Only
             </div>
           </label>
          </div> --}}

         <!-- Search Button -->
         <br>
         <div class="form-actions" >
           <button type="submit" id="search-button" class="btn btn-primary"><i class="fas fa-search"></i>Search</button>
         </div>
         </fieldset>
         </form>

         <div id="result" type='hidden'>
          <ul class="list-group">
            {{!-- <li id="in_mile">Distance In Mile :</li> --}}
            <li id="in_kilo">Distance is Kilo:</li>
            <li id='duration_text'>Duration:</li>
            {{!-- <li>IN MINUTES:</li>
            <li>FROM:</li>
            <li>TO:</li> --}}
          </ul>
        </div>
        
        </><!-- End Sidebar Content -->
        <div class="well" id="search-results">
          <h4>Search Results</h4>
          <div>
            {{#if results}}
            <form action='/auth/trips' method="post">
            <table class = 'table table-stripped'>
            <thead>
              <tr>
                {{!-- <th> id</th> --}}
                <th> From </th>
                <th> To </th>
                <th> date</th>
                <th> time</th>
                {{!-- <th> Select Ride</th> --}}
                {{!-- <th> women</th> --}}
              </tr>
            </thead>
            {{#each results}}
            <tr>
              {{!-- <td>{{this.id}}</td> --}}
              <td> {{this.source}} </td>
               <td> {{this.destination}} </td>
               <td> {{dateFormat this.date "dddd  MMM, D,   YYYY "}}</td>
               <td> {{this.time}}</td>
               <td> {{this.NBofSeatsAV}}</td>
               <td><button type="submit" class="btn" name="tripId" value="{{this.id}}">Request</input></td>
              <!-- no need to know which user clicked the button because it's in the session.userId --> 
              <!-- I can't use id attr with td tag --> 
            </tr>
            {{/each}}
              </table>
              </form>
            {{/if}}
            {{#if message}}
              <h4 class="alert alert-danger mt-4">{{message}}</h4>
            {{/if}}
          </div>
        </div>
      </div>
      <div id="map" class="well"></div>
    </div>
  </div>

    <script>
        function initMap() {
          var directionsService = new google.maps.DirectionsService;
          var directionsDisplay = new google.maps.DirectionsRenderer;
          var map = new google.maps.Map(document.getElementById('map'), {
            zoom: 7,
            center: {lat: 34.1156, lng: 35.6744}
          });
          directionsDisplay.setMap(map);
          //calculateAndDisplayRoute(directionsService, directionsDisplay);
          
          var onChangeHandler = function() {
            calculateAndDisplayRoute(directionsService, directionsDisplay);
            calculateDistance();
          };
          document.getElementById('from').addEventListener('change', onChangeHandler);
          document.getElementById('to').addEventListener('change', onChangeHandler);
        }
        function calculateAndDisplayRoute(directionsService, directionsDisplay) {
          directionsService.route({
            origin: document.getElementById('from').value,
            destination: document.getElementById('to').value,
            travelMode: 'DRIVING'
          }, function(response, status) {
            if (status === 'OK') {
              directionsDisplay.setDirections(response);
            } else {
              window.alert('Directions request failed due to ' + status);
            }
          }); 
        }
          function calculateDistance(){
            var DistanceMatrixService = new google.maps.DistanceMatrixService();
            var origin = document.getElementById('from').value;
            var destination = document.getElementById('to').value;
            DistanceMatrixService.getDistanceMatrix(
              {
                origins: [origin],
                destinations: [destination],
                travelMode: google.maps.TravelMode["DRIVING"],
                unitSystem: google.maps.UnitSystem.metric,
                avoidHighways: false,
                avoidTolls: false
              }, save_results);
          }
          function save_results(response, status) {
            if (status != google.maps.DistanceMatrixStatus.OK) {
                $('#result').html(err);
            } else {
                var origin = response.originAddresses[0];
                var destination = response.destinationAddresses[0];
                if (response.rows[0].elements[0].status === "ZERO_RESULTS") {
                    $('#result').html("Sorry , not available to use this travel mode between " + origin + " and " + destination);
                } else {
                    var distance = response.rows[0].elements[0].distance;
                    var duration = response.rows[0].elements[0].duration;
                    var distance_in_kilo = distance.value / 1000; // the kilo meter
                    var distance_in_mile = distance.value / 1609.34; // the mile
                    var duration_text = duration.text;
                    console.log(duration)
                    appendResults(distance_in_kilo, distance_in_mile, duration_text);
                }
            }
        }
        function appendResults(distance_in_kilo, distance_in_mile, duration_text) {
            document.getElementById("in_kilo").innerHTML= "Distance In Km:" + distance_in_kilo.toFixed(2);  
            document.getElementById("duration_text").innerHTML = "Duration: " + duration_text;
        }
      </script>

      <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=API_KEY&callback=initMap"> 
      </script>
      
</body>


</html>